# FlowTemplate

The Flow Template is intended to be copied and modified for each new project that needs to be built. It contains the standard structure for flows, calls to utility flows, as well as a standard template for custom subflows.
It is the only part of the framework that should in fact be modified by makers, but only after making a copy. The original template should still remain intact for others to use it.

## Version compatibility

The code is compatible with Power Automate Desktop version 2.43.204.24107 and later. Backward compatibility is not guaranteed, but it might work with earlier versions, too.
The code currently does not have a version for flows with Power Fx enabled. 

## Inputs expected

## Output produced

The flow produces several output variables that are returned to the parent flow (cloud or desktop) after execution:

1. **ErrorMessage** - Contains the last error message generated by the flow before it stopped. Should be marked as **sensitive** in case the message may contain any sensitive data.
1. **Output_IsSuccess** - Contains a boolean value that is equal to `True` when the flow completes successfully, or `False` when it fails.

## Minimal path to awesome

1. If you have not prepared an environment and a solution for the framework yet:
    1. Open the browser and navigate to [Power Automate cloud portal](https://make.powerautomate.com/)
    1. Create an dedicated environment for the Framework (DEV environments for other flows should contain a managed solution of the Framework - see **Notes** below)
    1. Create a solution called **PADFramework** in the new environment
1. If you have not created the other utility flows within the framework, create them first, as they will be used as child flows in the template.
1. Open **Power Automate Desktop**
1. Create a new flow called **PADFramework: FlowTemplate** - make sure to not enable Power Fx when creating it

    ![View of the flow creation window in PAD](./assets/creating-the-flow.png)

1. Create the following output variables (use the same names for "Variable name" and "External name" fields to avoid unneccessary confusion):
    1. ErrorMessage (Data type: Text; Mark as sensitive - True)

        ![View of the parameters for the 'ErrorMessage' input variable in PAD](./assets/error-message-variable-parameters.png)

    1. Output_IsSuccess (Data type: Boolean; Mark as sensitive - False)
1. Create the following subflows:
    1. **CloseBrowser** 
    1. **CloseExcel** 
    1. **ExecuteMainFlow**
    1. **Init**
    1. **LaunchBrowser**
    1. **Logger**
    1. **LoginToWebPage**
    1. **PrepareSystem**
    1. **PrepareWebPage**
    1. **StopFlow**
    1. **TakeScreenshot**
    1. **Template**
    1. **ThrowFatalError**
1. Copy the code in the files in `\source\` and paste it into Power Automate Desktop flow designer window into the appropriate subflows:
    1. **main.txt** to **Main**
    1. **close-browser.txt** to **CloseBrowser** 
    1. **close-excel.txt** to **CloseExcel** 
    1. **execute-main-flow.txt** to **ExecuteMainFlow**
    1. **init.txt** to **Init**
    1. **launch-browser.txt** to **LaunchBrowser**
    1. **logger.txt** to **Logger**
    1. **login-to-web-page.txt** to **LoginToWebPage**
    1. **prepare-system.txt** to **PrepareSystem**
    1. **prepare-web-page.txt** to **PrepareWebPage**
    1. **stop-flow.txt** to **StopFlow**
    1. **take-screenshot.txt** to **TakeScreenshot**
    1. **template.txt** to **Template**
    1. **throw-fatal-error.txt** to **ThrowFatalError**
1. Review the code for any syntax errors

    ![View of the code in the Main subflow in PAD](./assets/main-subflow-example.png)

1. Click **Save** in the flow designer
1. Add the **PADFramework: FlowTemplate** flow to the **PADFramework** solution for exporting it to other environments

    ![View of the menu path to add an existing desktop flow to a solution](./assets/adding-existing-desktop-flow-to-solution.png)

1. When exporting to other environments, export it as a **Managed** solution, so that it can be used, but not modified. Logger should be managed even in DEV environments for other flows (see **Notes** below)
1. **Enjoy**

## Notes

### Environments

The Framework should have its own dedicated development environment. This is the only environment where the Framework should reside as an unmanaged solution. 

It should be imported as a managed solution to all other environments where flows will use the framework, including normal DEV, TEST, UAT and other non-production environments. This is so that changes cannot be made to the framework outside of its own DEV environment, but it can be used by calling utility flows such as the **Logger** as child flows, as well as making copies of the template flows for new projects.

## Using the template

When makers want to start creating a new flow, they should follow these guidelines: 
1. Create a project directory on the machine or a network directory for:
    1. Logs (if logging to files)
    1. Config (if a config file is used)
    1. Flow (if temporary files and/or screenshots are used)
1. Make a copy of the Flow Template and use it as the basis

    ![View of the menu path to add an existing desktop flow to a solution](./assets/creating-a-copy-of-the-flow.png)

1. Adjust the following subflows appropriately as described in the comments:
    1. **Init**
    1. **Config**
    1. **PrepareSystem**
1. Remove any unneccesary subflows from the copy (e.g. any Browser-related subflows if web automation is not part of the target flow)
1. Copy the **Template** subflow for any custom subflows that are needed and edit the **Add item to list** action in it to add the correct name of the subflow to the subflow names list.
1. Add appropriate subflow calls for these custom subflows to parent subflows